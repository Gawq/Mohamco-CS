# 0. TCP/IP 4계층 모델

인터넷 프로토콜 스위트는 인터넷에서 컴퓨터들이 서로 정보를 주고받는 데 쓰이는 프로토콜의 집합이다.
이의 정이가 2가지 존재하는데 TCP/IP 4계층 모델과 OSI 7계층 모델이 있다.
여기서는 TCP/IP 4계층 모델을 중심으로 설명하겠다.

# 1. 계층 구조

TCP/IP 계층은 4개의 계층을 갖고 있으며 OSI 7계층과 많이 비교한다.

![image](https://user-images.githubusercontent.com/77488652/211266431-284c67b0-5650-4044-8ed6-dfbf4178097f.png)

OSI 계층은 애플리케이션 계층을 3개로 쪼개고 링크 계층을 2개로 나눠서 표현하는 점이 다르다.
특히 인터넷 계층을 네트워크 계층이라고 부르는 용어도 다르다.

이 계층들은 특정 계층이 변경되었을 때 다른 계층이 영향을 받지 않도록 설계되어 있다.
예를 들어 TCP를 UDP로 변경했다 한들 웹 브라우저를 다시 설치해야 하는 것은 아니다.

## 1.1 애플리케이션 계층

애플리케이션 계층에는

- FTP
  - 장치 간 파일을 전송하는데 사용
- HTTP
  - World Wide Web를 위한 통신의 기초. 웹 사이트를 이용하는데 쓰임
- SSH
  - 암호화 네트워크 프로토콜
- SMTP
  - 전자 메일 전송을 위해 사용
- DNS
  - Domain Name Service

등 응용 프로그램이 사용되는 프로토콜 계층이며 웹 서비스와 같은 서비스를 실직적으로 사람들에게 제공하는 층이다.

## 1.2 전송 계층

전송 계층은 송신자와 수신자를 연결하는 통신 서비스를 제공한다.

연결 지향 데이터 스트림 지원, 신뢰성, 흐름 제어를 제공할 수 있다.

애플리케이션과 인터넷 계층 사이의 데이터가 전달될 때 중계 역할을 하는데 대표적으로 TCP , UDP가 있다.

### TCP의 가상회선 패킷 교환 방식

가상회선 패킷 교환 방식은 각 패킷에는 가상회선 식별자가 포함되어 모든 패킷을 전송하면 가상회선이 해제되고 패킷들은 전송된 순서대로 도착하는 방식이다.

### UDP의 데이터그램 패킷 교환 방식

데이터그램 패킷 교환 방식은 패킷이 독립적으로 이동하며 최적의 경로로 가는 방식이다. 하지만 하나의 메시지에서 분할된 여러 패킷은 서로 다른 경로로 전송될 수 있으며 도착한 순서도 다를 수 있다.

### TCP 연결 성립 과정

TCP는 신뢰성을 확보할 때 `3-way handshake` 라는 작업을 진행한다.

1. SYN 단계 (요청)
2. SYN + ACK 단계
3. ACK 단계 (응답)

이렇게 3-웨이 핸드셰이크 과정 이후 신뢰성이 구축되고 데이터 전송을 시작한다. TCP는 이 과정이 있기에 신뢰성 있는 계층이라고 하며 UDP는 없기에 신뢰성 없는 계층이라고 부른다.

### TCP 연결 해제 과정

TCP가 연결을 해제할 때는 `4-way handshake` 과정이 발생한다.

1. 클라가 닫으려고 할 때 FIN으로 설정된 세그먼트 전송, 클라는 FIN_WAIT_1 상태로 서버의 응답을 기다림
2. 서버가 클라에게 ACK라는 승인 세그먼트 전송, CLOSE_WAIT 상태가 되고 클라가 세그먼트 받으면 FIN_WAIT_2 상태로 변경
3. 서버는 ACK를 보내고 일정 시간 이후 클라에게 FIN 세그먼트 전송
4. 클라는 TIME_WAIT 상태가 되고 다시 서버로 ACK를 보냄 서버는 CLOSED 상태가 된다. 이후 클라는 어느 정도 시간 이후 연결이 닫히고 클라, 서버의 모든 자원의 연결이 해제된다.

여기서 TIME_WAIT을 왜 사용하는가? 이처럼 그냥 연결을 바로 닫지 않고 일정 시간 뒤에 닫는 이유는

1. 지연 패킷이 발생할 경우를 대비하기 위함이다.
2. 지연 패킷을 처리하지 못한다면 데이터 무결성 문제가 발생하기 때문이다.

> **TIME_WAIT**<br>
> 소켓이 바로 소멸되지 않고 일정 시간 유지되는 상태. 지연 패킷 등의 문제점을 해결하는 데 쓰인다.
>
> **데이터 무결성**<br>
> 데이터의 정확성과 일관성을 유지하고 보증하는 것

## 1.3 인터넷 계층

인터넷 계층은 장치로부터 받은 네트워크 패킷을 IP 주소로 지정된 목적지로 전송하기 위해 사용되는 계층이다.
IP, ARP, ICMP 등이 있으며 패킷을 수신해야 할 상대의 주소를 지정하여 데이터를 전달한다.
상대방이 제대로 받았는지에 대해 보장하지 않는 `비연결형적`인 특징을 가지고 있다.

## 1.4 링크 계층

링크 계층은 네트워크 접근 계층이라고도 하며 전선, 광섬유, 무선 등으로 실질적으로 데이터를 전달하며 장치 간 신호를 주고받는 규칙을 정하는 계층이다.

물리 계층(유무선 LAN), 데이터 링크 계층(이더넷 프레임통한 제어)으로 나누어 지기도 한다.

## 계층 간 데이터 송수신 과정

예를 들어 HTTP를 통해 웹 서버에 있는 데이터를 요청한다면 어떤 과정이 일어나는지 알아보자.

앱 계층에서 전송 계층으로 자신이 보내는 요청 값들이 캡슐화 -> 링크 계층에서 서버와 통신 -> 비캡슐화를 거쳐 데이터가 전송된다.

### 캡슐화 과정

캡슐화 과정은 상위 계층의 헤더와 데이터를 하위 계층의 데이터 부분에 포함시키고 해당 계층의 헤더를 삽입하는 과정이다.

1. 앱 계층의 데이터가 전송 계층으로 전달되면서 세그먼트 또는 데이터그램화 되며 TCP(L4) 헤더가 붙는다.
2. 그 이후 인터넷 계층으로 가면서 IP(L3) 헤더가 붙여져 패킷화가 되고
3. 이후 링크 계층으로 전달되면서 프레임 헤더와 프레임 트레일러가 붙어 프레임화가 된다.

### 비캡슐화 과정

비캡슐화 과정은 하위 계층에서 상위 계층으로 가며 각 계층의 헤더 부분을 제거하는 과정을 말한다.

# 2. PDU (Protocol Data Unit)

네트워크의 어떠한 계층에서 계층으로 데이터가 전달될 때 한 덩어리의 단위를 PDU라고 한다.
제어 관련 정보들이 포함된 헤더, 데이터를 의미하는 페이로드로 구성되어 있다.

PDU 중 아래 계층인 비트로 송수신하는 것이 모든 PDU중 가장 빠르고 효율성이 높은데 앱 계층에서 문자열 기반으로 송수신을 한다. 그 이유는 헤더에 authorization 값 등 다른 값들을 넣는 등 확장이 쉽기 때문이다.
